name: OpenAPI Quality Check

# this action runs only when OpenAPI spec files are modified
on:
  pull_request:
    branches: [main]
    paths:
      - 'api-spec/**/*.yaml'
      - 'api-spec/**/*.yml'

permissions:
  contents: read

jobs:
  openapi_quality:
    runs-on: ubuntu-latest
    name: OpenAPI Quality Check
    strategy:
      matrix:
        spec:
          - path: 'api-spec/v1/transactions-api.yaml'
            version: 'v1'
          - path: 'api-spec/v2/transactions-api.yaml'
            version: 'v2'
          - path: 'api-spec/v2.1/transactions-api.yaml'
            version: 'v2.1'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
    
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
    
      - name: Test API Key and Debug
        if: ${{ github.event.pull_request.head.repo.fork == false }}
        run: |
          echo "Testing Rate My OpenAPI API directly..."
          echo "API Key length: ${#RMOA_API_KEY} characters"

          # Test the API with curl to see actual error
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "https://api.ratemyopenapi.com/sync-report" \
            -H "Authorization: Bearer $RMOA_API_KEY" \
            -F "file=@${{ matrix.spec.path }}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response body:"
          echo "$BODY" | head -c 2000

          if [ "$HTTP_CODE" != "200" ]; then
            echo "API returned error - check response above"
            exit 1
          fi
        env:
          RMOA_API_KEY: ${{ secrets.RATEMYOPENAPI_API_KEY }}

      - name: Rate My OpenAPI - ${{ matrix.spec.version || matrix.spec.path }}
        if: ${{ github.event.pull_request.head.repo.fork == false && success() }}
        run: |
          npx rmoa lint \
            --filename ${{ matrix.spec.path }} \
            --api-key ${{ secrets.RATEMYOPENAPI_API_KEY }} \
            --minimum-score 80 \
            --max-warnings 57 \
            --max-errors 5
